version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: decamino-backend
    restart: unless-stopped
    env_file:
      - .env.production
    ports:
      - "3000:3000"
    networks:
      - traefik-network
    labels:
      # Traefik labels - DOAR pentru api.decaminoservicios.com
      # Nu interfereazÄƒ cu n8n.decaminoservicios.com sau alte servicii existente
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-network"
      
      # Router principal pentru api.decaminoservicios.com
      - "traefik.http.routers.backend-api.rule=Host(`api.decaminoservicios.com`)"
      - "traefik.http.routers.backend-api.entrypoints=websecure"
      - "traefik.http.routers.backend-api.tls.certresolver=myresolver"
      - "traefik.http.routers.backend-api.middlewares=backend-headers,backend-cors"
      
      # Service - portul container-ului backend
      - "traefik.http.services.backend-api.loadbalancer.server.port=3000"
      
      # Middleware pentru headers (doar pentru acest backend)
      - "traefik.http.middlewares.backend-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.backend-headers.headers.customrequestheaders.X-Forwarded-Port=443"
      
      # Middleware pentru CORS (permite request-uri de la frontend)
      - "traefik.http.middlewares.backend-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,PATCH,OPTIONS"
      - "traefik.http.middlewares.backend-cors.headers.accesscontrolallowheaders=Content-Type,Authorization,X-App-Source,X-App-Version,X-Client-Type"
      - "traefik.http.middlewares.backend-cors.headers.accesscontrolalloworiginlist=https://app.decaminoservicios.com,https://decaminoservicios.com"
      - "traefik.http.middlewares.backend-cors.headers.accesscontrolallowcredentials=true"
      - "traefik.http.middlewares.backend-cors.headers.accesscontrolmaxage=3600"
      - "traefik.http.middlewares.backend-cors.headers.addvaryheader=true"
    
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  traefik-network:
    external: true
